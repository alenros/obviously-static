---
import Layout from '../components/Layout.astro';
import GameTimer from '../components/GameTimer.astro';
import PlayerList from '../components/PlayerList.astro';
---

<Layout title="Word Battle - Game">
    <div class="screen active">
        <GameTimer />
        <div class="game-area">
            <div id="public-words-container" class="public-words">
                <!-- Public words will be displayed here -->
            </div>
            
            <PlayerList containerId="game-players-container" title="Players in Game" showGameStatus={true} />
        </div>
        <button id="leave-game-btn">Leave Game</button>
    </div>
</Layout>

<script>
import type { Room } from '../lib/room';

    let gameTimer: NodeJS.Timeout | null = null;

    document.addEventListener('DOMContentLoaded', async () => {
        // Get room code from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('code');
        
        if (!roomCode) {
            alert('No room code provided');
            window.location.href = '/';
            return;
        }
        
        // Get current player from localStorage
        const currentPlayerStr = localStorage.getItem('currentPlayer');
        if (!currentPlayerStr) {
            alert('No player data found');
            window.location.href = '/';
            return;
        }
        
        const currentPlayer = JSON.parse(currentPlayerStr);
        
        // Import Firebase singleton
        const { getDatabase, firebase } = await import('../lib/firebase');
        const database = getDatabase();
        
        // Get initial room data and start the game
        const roomSnapshot = await database.ref(`rooms/${roomCode}`).once('value');
        const roomData : Room = roomSnapshot.val();
        
        if (!roomData || roomData.status !== 'playing') {
            alert('Game not found or not started');
            window.location.href = '/';
            return;
        }
        
        // Initialize game UI
        startGameScreen(roomData);
        
        // Function to update game players list with their words
        function updateGamePlayersList(players: any, playerWords: any, publicWordChoices: any = {}) {
            const container = document.getElementById('game-players-container');
            if (!container || !players) return;
            
            container.innerHTML = '';
            
            const playerIds = Object.keys(players);
            const allSubmitted = playerIds.every(id => publicWordChoices[id]);
            
            Object.values(players).forEach((player: any) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player';
                
                const words = playerWords[player.id] || [];
                const wordsText = words.map((w: any) => w.text).join(', ');
                
                const hasSubmitted = publicWordChoices[player.id];
                // Show checkmark only if submitted AND not everyone has submitted yet
                const statusMark = hasSubmitted && !allSubmitted ? ' ✓' : '';
                
                playerDiv.innerHTML = `
                    <span class="player-name">${player.name}${statusMark}</span>
                    <span class="player-words">${wordsText}</span>
                `;
                container.appendChild(playerDiv);
            });
        }
        
        // Track selected public word
        let selectedPublicWord: any = null;
        let hasSubmittedChoice = false;
        
        // Function to display public words (clickable)
        function displayPublicWords(publicWords: any[]) {
            const container = document.getElementById('public-words-container');
            if (!container) return;
            
            container.innerHTML = '<h3>Choose One Public Word</h3><div id="public-words-list"></div><button id="submit-choice-btn" disabled>Submit Choice</button>';
            
            const wordsList = document.getElementById('public-words-list');
            if (!wordsList) return;
            
            publicWords.forEach((word: any, index: number) => {
                const wordDiv = document.createElement('div');
                wordDiv.className = 'word-item clickable';
                wordDiv.textContent = word.text;
                wordDiv.dataset.index = String(index);
                
                wordDiv.addEventListener('click', () => {
                    if (hasSubmittedChoice) return;
                    
                    // Deselect all
                    wordsList.querySelectorAll('.word-item').forEach(w => w.classList.remove('selected'));
                    
                    // Select this one
                    wordDiv.classList.add('selected');
                    selectedPublicWord = word;
                    
                    // Enable submit button
                    const submitBtn = document.getElementById('submit-choice-btn') as HTMLButtonElement;
                    if (submitBtn) submitBtn.disabled = false;
                });
                
                wordsList.appendChild(wordDiv);
            });
            
            // Submit choice button handler
            const submitBtn = document.getElementById('submit-choice-btn');
            submitBtn?.addEventListener('click', async () => {
                if (!selectedPublicWord || hasSubmittedChoice) return;
                
                try {
                    await database.ref(`rooms/${roomCode}/publicWordChoices/${currentPlayer.id}`).set(selectedPublicWord);
                    hasSubmittedChoice = true;
                    
                    const submitBtn = document.getElementById('submit-choice-btn') as HTMLButtonElement;
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Choice Submitted ✓';
                    }
                    
                    // Disable further clicks
                    document.querySelectorAll('.word-item.clickable').forEach(w => {
                        (w as HTMLElement).style.pointerEvents = 'none';
                        (w as HTMLElement).style.opacity = '0.6';
                    });
                    
                } catch (error) {
                    console.error('Error submitting choice:', error);
                    alert('Failed to submit choice');
                }
            });
        }
        
        // Function to start the game timer
        function startServerBasedTimer(startTime: number, duration: number) {
            const timerElement = document.getElementById('game-timer');
            
            const updateTimer = () => {
                const now = Date.now();
                const elapsed = Math.floor((now - startTime) / 1000);
                const timeLeft = Math.max(0, duration - elapsed);
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                if (timerElement) {
                    timerElement.textContent = `Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
                
                if (timeLeft <= 0) {
                    if (gameTimer) {
                        clearInterval(gameTimer);
                        gameTimer = null;
                    }
                    endGame();
                    return;
                }
            };
            
            // Clear any existing timer
            if (gameTimer) {
                clearInterval(gameTimer);
            }
            
            // Update immediately
            updateTimer();
            
            // Start the interval
            gameTimer = setInterval(updateTimer, 1000);
        }
        
        // Function to start game screen
        function startGameScreen(roomData: Room) {
            // Clean up any existing timer first
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
            
            // Display public words
            displayPublicWords(roomData.publicWords || []);
            
            // Update players list with their assigned words
            updateGamePlayersList(roomData.players, roomData.playerWords || {}, roomData.publicWordChoices || {});
            
            // Listen for public word choice updates
            database.ref(`rooms/${roomCode}/publicWordChoices`).on('value', (snapshot) => {
                const choices = snapshot.val() || {};
                updateGamePlayersList(roomData.players, roomData.playerWords || {}, choices);
            });
            
            // Start timer
            const startTime = roomData.startTime || Date.now();
            startServerBasedTimer(startTime, roomData.duration || 180);
        }
        
        // Function to end game
        function endGame() {
            alert("Time's up! Game ended.");
            // Could redirect to results screen or back to lobby
        }
        
        // Leave game button handler
        const leaveGameBtn = document.getElementById('leave-game-btn');
        leaveGameBtn?.addEventListener('click', async () => {
            try {
                await database.ref(`rooms/${roomCode}/players/${currentPlayer.id}`).remove();
                
                // Clean up listeners
                database.ref(`rooms/${roomCode}`).off();
                database.ref(`rooms/${roomCode}/publicWordChoices`).off();
                
                // Clean up timer
                if (gameTimer) {
                    clearInterval(gameTimer);
                    gameTimer = null;
                }
                
                // Clear localStorage
                localStorage.removeItem('currentRoom');
                localStorage.removeItem('currentPlayer');
                
                window.location.href = '/';
                
            } catch (error) {
                console.error('Error leaving room:', error);
                alert('Failed to leave room');
            }
        });
    });
</script>