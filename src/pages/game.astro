---
import Layout from '../components/Layout.astro';
import GameTimer from '../components/GameTimer.astro';
import PlayerList from '../components/PlayerList.astro';
import WordSubmissions from '../components/WordSubmissions.astro';
---

<Layout title="Word Battle - Game">
    <div class="screen active">
        <GameTimer />
        <div class="game-area">
            <h3 id="current-prompt">Current prompt will appear here</h3>
            <div id="secret-word-display" style="display: none;">
                <h4>Secret Word:</h4>
                <div class="secret-word" id="secret-word"></div>
            </div>
            <input type="text" class="word-input" id="word-input" placeholder="Type your word here..." disabled>
            <button id="submit-word-btn" disabled>Submit Word</button>
            
            <PlayerList containerId="game-players-container" title="Players in Game" showGameStatus={true} />
            
            <WordSubmissions />
        </div>
        <button id="leave-game-btn">Leave Game</button>
    </div>
</Layout>

<script>
import type { Room } from '../lib/room';
import { createGameController } from '../lib/game-controller';
import { createGameEventHandler } from '../lib/game-events';

    let gameController: any = null;
    let eventHandler: any = null;

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Get room code from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('code');
            
            if (!roomCode) {
                alert('No room code provided');
                window.location.href = '/';
                return;
            }
            
            // Get current player from localStorage
            const currentPlayerStr = localStorage.getItem('currentPlayer');
            if (!currentPlayerStr) {
                alert('No player data found');
                window.location.href = '/';
                return;
            }
            
            const currentPlayer = JSON.parse(currentPlayerStr);
            
            // Import Firebase singleton and get room data
            const { getDatabase } = await import('../lib/firebase');
            const database = getDatabase();
            
            // Get initial room data and start the game
            const roomSnapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const roomData: Room = roomSnapshot.val();
            
            if (!roomData || roomData.status !== 'playing') {
                alert('Game not found or not started');
                window.location.href = '/';
                return;
            }
            
            // Create game controller and event handler
            gameController = await createGameController(roomCode, currentPlayer);
            eventHandler = createGameEventHandler(gameController);
            
            // Initialize game screen
            gameController.startGameScreen(roomData);
            
            // Set up game listeners
            gameController.setupGameListeners();
            
        } catch (error) {
            console.error('Error initializing game:', error);
            alert('Failed to initialize game');
            window.location.href = '/';
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (gameController) {
            gameController.cleanup();
        }
        if (eventHandler) {
            eventHandler.cleanup();
        }
    });
</script>