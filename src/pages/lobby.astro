---
import Layout from '../components/Layout.astro';
import RoomCode from '../components/RoomCode.astro';
import PlayerList from '../components/PlayerList.astro';
---

<Layout title="Word Battle - Lobby">
    <div class="screen active">
        <h2>Waiting Room</h2>
        <RoomCode />
        <PlayerList containerId="players-container" title="Players" />
        <button id="start-game-btn" style="display: none;">Start Game</button>
        <button id="leave-room-btn">Leave Room</button>
    </div>
</Layout>

<script>
    // Get base URL from Astro config
    const BASE_URL = import.meta.env.BASE_URL;

    document.addEventListener('DOMContentLoaded', async () => {
        // Get room code from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('code');
        
        if (!roomCode) {
            alert('No room code provided');
            window.location.href = BASE_URL;
            return;
        }
        
        // Get current player from localStorage
        const currentPlayerStr = localStorage.getItem('currentPlayer');
        if (!currentPlayerStr) {
            alert('No player data found');
            window.location.href = BASE_URL;
            return;
        }
        
        const currentPlayer = JSON.parse(currentPlayerStr);
        
        // Display room code
        const roomCodeDisplay = document.getElementById('display-room-code');
        if (roomCodeDisplay) {
            roomCodeDisplay.textContent = roomCode;
        }
        
        // Import Firebase singleton
        const { getDatabase } = await import('../lib/firebase');
        const database = getDatabase();
        
        // Function to update players list
        function updatePlayersList(players: any) {
            const container = document.getElementById('players-container');
            if (!container || !players) return;
            
            container.innerHTML = '';
            
            Object.values(players).forEach((player: any) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player';
                playerDiv.innerHTML = `
                    <span class="player-name">${player.name}</span>
                    ${player.isHost ? '<span class="player-status">Host</span>' : ''}
                `;
                container.appendChild(playerDiv);
            });
        }
        
        // Listen for room updates
        database.ref(`rooms/${roomCode}`).on('value', (snapshot) => {
            const roomData = snapshot.val();
            if (!roomData) {
                alert('Room no longer exists');
                window.location.href = BASE_URL;
                return;
            }
            
            updatePlayersList(roomData.players);
            
            // Show start button only to host
            const startBtn = document.getElementById('start-game-btn');
            if (startBtn && currentPlayer.isHost) {
                const playerCount = Object.keys(roomData.players || {}).length;
                startBtn.style.display = playerCount >= 2 ? 'block' : 'none';
            }
            
            // Check if game started
            if (roomData.status === 'playing') {
                window.location.href = `${BASE_URL}game?code=${roomCode}`;
            }
        });
        
        // Start game button handler
        const startGameBtn = document.getElementById('start-game-btn');
        startGameBtn?.addEventListener('click', async () => {
            if (!currentPlayer.isHost) return;
            
            try {
                // Import word selection
                const { pickRandomWords } = await import('../lib/words');
                
                // Get all players
                const roomSnapshot = await database.ref(`rooms/${roomCode}`).once('value');
                const roomData = roomSnapshot.val();
                const playerIds = Object.keys(roomData.players || {});
                const playerCount = playerIds.length;
                
                // Calculate total words needed: (players Ã— 2) + (players + 1)
                const totalWordsNeeded = (playerCount * 2) + (playerCount + 1);
                
                // Pick random unique words using Fisher-Yates
                const selectedWords = pickRandomWords(totalWordsNeeded);
                
                // Assign 2 words per player
                const playerWords: { [key: string]: any[] } = {};
                let wordIndex = 0;
                
                for (const playerId of playerIds) {
                    playerWords[playerId] = [
                        selectedWords[wordIndex++],
                        selectedWords[wordIndex++]
                    ];
                }
                
                // Remaining words are public (n+1 words)
                const publicWords = selectedWords.slice(wordIndex);
                
                const gameData = {
                    status: 'playing',
                    playerWords: playerWords,
                    publicWords: publicWords,
                    startTime: Date.now(),
                    duration: 180, // 3 minutes
                    submissions: {},
                    points: 0,
                    fouls: 0
                };
                
                await database.ref(`rooms/${roomCode}`).update(gameData);
                
            } catch (error) {
                console.error('Error starting game:', error);
                alert('Failed to start game');
            }
        });
        
        // Leave room button handler
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        leaveRoomBtn?.addEventListener('click', async () => {
            try {
                await database.ref(`rooms/${roomCode}/players/${currentPlayer.id}`).remove();
                
                // Clean up listeners
                database.ref(`rooms/${roomCode}`).off();
                
                // Clear localStorage
                localStorage.removeItem('currentRoom');
                localStorage.removeItem('currentPlayer');
                
                window.location.href = BASE_URL;
                
            } catch (error) {
                console.error('Error leaving room:', error);
                alert('Failed to leave room');
            }
        });
    });
</script>