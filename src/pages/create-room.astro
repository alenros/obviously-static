---
import Layout from '../components/Layout.astro';
---

<Layout title="Word Battle - Create Room">
    <div class="screen active">
        <h2>Create a Room</h2>
        <div class="input-group">
            <label for="room-name">Room Name (Optional)</label>
            <input type="text" id="room-name" placeholder="Enter room name" maxlength="30">
        </div>
        <button id="create-room-btn">Create Room</button>
        <button id="back-btn">Back</button>
    </div>
</Layout>

<script>
    // Utility functions
    function generateRoomCode(): string {
        return Math.random().toString(36).substr(2, 6).toUpperCase();
    }

    function generatePlayerId(): string {
        return 'player_' + Math.random().toString(36).substr(2, 9);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const roomNameInput = document.getElementById('room-name') as HTMLInputElement;
        const createRoomBtn = document.getElementById('create-room-btn');
        const backBtn = document.getElementById('back-btn');

        createRoomBtn?.addEventListener('click', async () => {
            const playerName = localStorage.getItem('playerName');
            const roomName = roomNameInput?.value.trim() || 'Unnamed Room';
            
            if (!playerName) {
                alert('Player name not found. Please go back to home.');
                window.location.href = '/';
                return;
            }
            
            try {
                // Import Firebase singleton
                const { getDatabase, firebase } = await import('../lib/firebase');
                const database = getDatabase();
                
                const roomCode = generateRoomCode();
                const playerId = generatePlayerId();
                
                if (!playerId) {
                    alert('Failed to generate player ID');
                    return;
                }
                
                const currentPlayer = {
                    id: playerId,
                    name: playerName,
                    isHost: true
                };
                
                const roomData = {
                    code: roomCode,
                    name: roomName,
                    status: 'waiting',
                    players: {
                        [playerId]: currentPlayer
                    },
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    hostId: playerId
                };
                
                await database.ref(`rooms/${roomCode}`).set(roomData);
                
                // Store room and player data
                localStorage.setItem('currentRoom', roomCode);
                localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
                
                // Redirect to lobby
                window.location.href = `/lobby?code=${roomCode}`;
                
            } catch (error) {
                console.error('Error creating room:', error);
                alert('Failed to create room');
            }
        });

        backBtn?.addEventListener('click', () => {
            window.location.href = '/';
        });
    });
</script>